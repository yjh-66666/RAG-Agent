# ä¼ä¸šçº§ RAG ç³»ç»Ÿè¿è¡ŒæŒ‡å—

## ğŸ“‹ å‰ç½®æ¡ä»¶æ£€æŸ¥

âœ… å·²å®‰è£…æ‰€æœ‰ä¾èµ–ï¼š`pip install -r requirements_v2.txt`  
âœ… å·²é…ç½® `.env` æ–‡ä»¶ï¼ŒåŒ…å« `OPENAI_API_KEY`ï¼ˆDeepSeek API Keyï¼‰  
âœ… å·²å‡†å¤‡å¥½æ¼”ç¤ºæ–‡æ¡£ï¼ˆä½äº `demo_docs/` æ–‡ä»¶å¤¹ï¼‰

---

## ğŸš€ ç¬¬ä¸€æ­¥ï¼šå¯åŠ¨æœåŠ¡å™¨

### 1.1 æ‰“å¼€ç»ˆç«¯ï¼Œè¿›å…¥é¡¹ç›®ç›®å½•

```bash
cd zhi_liao_knowledge_assistant
```

### 1.2 å¯åŠ¨ FastAPI æœåŠ¡å™¨

```bash
python RAG.py
```

**é¢„æœŸè¾“å‡ºï¼š**
```
============================================================
ä¼ä¸šçº§ RAG + Agent æœåŠ¡å¯åŠ¨
é…ç½®: LLM=DeepSeek, Embedding=æœ¬åœ°BGEï¼ˆç¦»çº¿æ¨¡å¼ï¼‰
æ¥å£æ–‡æ¡£: http://127.0.0.1:8000/docs
å¥åº·æ£€æŸ¥: http://127.0.0.1:8000/health
============================================================
INFO:     Started server process
INFO:     Uvicorn running on http://127.0.0.1:8000
```

### 1.3 éªŒè¯æœåŠ¡æ˜¯å¦æ­£å¸¸

æ‰“å¼€æµè§ˆå™¨è®¿é—®ï¼š
- **å¥åº·æ£€æŸ¥**ï¼šhttp://127.0.0.1:8000/health
- **API æ–‡æ¡£**ï¼šhttp://127.0.0.1:8000/docs

---

## ğŸ” ç¬¬äºŒæ­¥ï¼šè·å–è®¿é—®ä»¤ç‰Œï¼ˆJWT Tokenï¼‰

### 2.1 ä½¿ç”¨ API æ–‡æ¡£ç•Œé¢ï¼ˆæ¨èï¼‰

1. è®¿é—® http://127.0.0.1:8000/docs
2. æ‰¾åˆ° `/auth/dev_login` æ¥å£
3. ç‚¹å‡» "Try it out"
4. è¾“å…¥ä»¥ä¸‹å†…å®¹ï¼š

```json
{
  "user": "demo_user",
  "roles": ["public", "admin"],
  "department": "æŠ€æœ¯éƒ¨",
  "exp_minutes": 1440
}
```

5. ç‚¹å‡» "Execute"
6. **å¤åˆ¶è¿”å›çš„ `access_token`**ï¼ˆåé¢ä¼šç”¨åˆ°ï¼‰

### 2.2 ä½¿ç”¨ curl å‘½ä»¤ï¼ˆå‘½ä»¤è¡Œæ–¹å¼ï¼‰

```bash
curl -X POST "http://127.0.0.1:8000/auth/dev_login" \
  -H "Content-Type: application/json" \
  -d "{\"user\": \"demo_user\", \"roles\": [\"public\", \"admin\"], \"department\": \"æŠ€æœ¯éƒ¨\"}"
```

---

## ğŸ“š ç¬¬ä¸‰æ­¥ï¼šå¯¼å…¥æ–‡æ¡£åˆ°çŸ¥è¯†åº“

### 3.1 ä½¿ç”¨ API æ–‡æ¡£ç•Œé¢

1. åœ¨ http://127.0.0.1:8000/docs ä¸­æ‰¾åˆ° `/ingest` æ¥å£
2. ç‚¹å‡»å³ä¸Šè§’çš„ **"Authorize"** æŒ‰é’®
3. è¾“å…¥ï¼š`Bearer <ä½ çš„access_token>`ï¼ˆæ³¨æ„ Bearer åé¢æœ‰ç©ºæ ¼ï¼‰
4. ç‚¹å‡» "Try it out"
5. è¾“å…¥ä»¥ä¸‹å†…å®¹ï¼š

```json
{
  "paths": ["./demo_docs"],
  "department": "æŠ€æœ¯éƒ¨",
  "access_control": ["public"],
  "custom_metadata": {}
}
```

6. ç‚¹å‡» "Execute"
7. æŸ¥çœ‹è¿”å›ç»“æœï¼Œåº”è¯¥æ˜¾ç¤ºæˆåŠŸå¯¼å…¥äº† 5 ä¸ªæ–‡æ¡£

### 3.2 ä½¿ç”¨ curl å‘½ä»¤

```bash
curl -X POST "http://127.0.0.1:8000/ingest" \
  -H "Authorization: Bearer <ä½ çš„access_token>" \
  -H "Content-Type: application/json" \
  -d "{\"paths\": [\"./demo_docs\"], \"department\": \"æŠ€æœ¯éƒ¨\"}"
```

**é¢„æœŸè¿”å›ï¼š**
```json
{
  "request_id": "...",
  "success": true,
  "data": {
    "ingest": {
      "status": "ok",
      "documents": 5,
      "chunks": 15
    }
  }
}
```

---

## ğŸ” ç¬¬å››æ­¥ï¼šæµ‹è¯•æœç´¢åŠŸèƒ½

### 4.1 æœç´¢æ–‡æ¡£ï¼ˆ/searchï¼‰

**è¯·æ±‚ç¤ºä¾‹ï¼š**
```json
{
  "query": "å¹´å‡æ”¿ç­–",
  "k": 5,
  "freshness_weight": 0.3
}
```

**é¢„æœŸç»“æœï¼š** è¿”å›ä¸"å¹´å‡æ”¿ç­–"ç›¸å…³çš„æ–‡æ¡£ç‰‡æ®µ

### 4.2 æ™ºèƒ½é—®ç­”ï¼ˆ/queryï¼‰

**è¯·æ±‚ç¤ºä¾‹ï¼š**
```json
{
  "question": "å‘˜å·¥å¹´å‡æœ‰å¤šå°‘å¤©ï¼Ÿ"
}
```

**é¢„æœŸç»“æœï¼š** è¿”å›åŸºäºçŸ¥è¯†åº“çš„å®Œæ•´ç­”æ¡ˆï¼ŒåŒ…å«å¼•ç”¨æ¥æº

---

## ğŸ¤– ç¬¬äº”æ­¥ï¼šæµ‹è¯• Agent æ™ºèƒ½å¯¹è¯

### 5.1 Agent èŠå¤©ï¼ˆ/agent_chatï¼‰

Agent å¯ä»¥è‡ªåŠ¨è¯†åˆ«ç”¨æˆ·æ„å›¾ï¼š
- **æœç´¢æ„å›¾**ï¼šåŒ…å«"æœç´¢"ã€"åˆ—å‡º"ã€"æœ‰å“ªäº›"ç­‰å…³é”®è¯
- **æ–‡æ¡£ä¿¡æ¯**ï¼šåŒ…å«"document_id"ã€"ç‰ˆæœ¬"ç­‰å…³é”®è¯
- **é—®ç­”æ„å›¾**ï¼šå…¶ä»–é—®é¢˜

**è¯·æ±‚ç¤ºä¾‹ 1 - æœç´¢ï¼š**
```json
{
  "message": "æœç´¢ä¸€ä¸‹å…³äºæŠ¥é”€æµç¨‹çš„æ–‡æ¡£"
}
```

**è¯·æ±‚ç¤ºä¾‹ 2 - é—®ç­”ï¼š**
```json
{
  "message": "æ–°å‘˜å·¥å¦‚ä½•ç”³è¯·è´¦å·ï¼Ÿ"
}
```

**è¯·æ±‚ç¤ºä¾‹ 3 - æ–‡æ¡£ä¿¡æ¯ï¼š**
```json
{
  "message": "æŸ¥è¯¢ document_id ä¸º xxx çš„æ–‡æ¡£ä¿¡æ¯"
}
```

---

## ğŸ“Š æ¼”ç¤ºè§†é¢‘å»ºè®®æµç¨‹

### åœºæ™¯ä¸€ï¼šç³»ç»Ÿä»‹ç»ï¼ˆ30ç§’ï¼‰
1. æ‰“å¼€æµè§ˆå™¨è®¿é—® http://127.0.0.1:8000/docs
2. å±•ç¤º API æ–‡æ¡£ç•Œé¢
3. è®¿é—®å¥åº·æ£€æŸ¥æ¥å£ï¼Œå±•ç¤ºç³»ç»ŸçŠ¶æ€

### åœºæ™¯äºŒï¼šå¯¼å…¥æ–‡æ¡£ï¼ˆ1åˆ†é’Ÿï¼‰
1. å±•ç¤º demo_docs æ–‡ä»¶å¤¹ä¸­çš„ 5 ä¸ªæ–‡æ¡£
2. è°ƒç”¨ `/auth/dev_login` è·å– token
3. è°ƒç”¨ `/ingest` å¯¼å…¥æ–‡æ¡£
4. å±•ç¤ºå¯¼å…¥æˆåŠŸçš„ç»“æœ

### åœºæ™¯ä¸‰ï¼šæœç´¢åŠŸèƒ½ï¼ˆ1åˆ†é’Ÿï¼‰
1. è°ƒç”¨ `/search` æœç´¢"å¹´å‡æ”¿ç­–"
2. å±•ç¤ºè¿”å›çš„ç›¸å…³æ–‡æ¡£ç‰‡æ®µ
3. è°ƒç”¨ `/search` æœç´¢"æŠ¥é”€æµç¨‹"
4. å±•ç¤ºæœç´¢ç»“æœ

### åœºæ™¯å››ï¼šæ™ºèƒ½é—®ç­”ï¼ˆ1.5åˆ†é’Ÿï¼‰
1. è°ƒç”¨ `/query` æé—®ï¼š"å‘˜å·¥å¹´å‡æœ‰å¤šå°‘å¤©ï¼Ÿ"
2. å±•ç¤º AI ç”Ÿæˆçš„å®Œæ•´ç­”æ¡ˆå’Œå¼•ç”¨æ¥æº
3. æé—®ï¼š"å¦‚ä½•ç”³è¯·è´¦å·ï¼Ÿ"
4. å±•ç¤ºç­”æ¡ˆ

### åœºæ™¯äº”ï¼šAgent å¯¹è¯ï¼ˆ1.5åˆ†é’Ÿï¼‰
1. è°ƒç”¨ `/agent_chat` å‘é€ï¼š"æœç´¢ä¸€ä¸‹å…³äºä»£ç è¯„å®¡çš„æ–‡æ¡£"
2. å±•ç¤º Agent è‡ªåŠ¨è¯†åˆ«ä¸ºæœç´¢æ„å›¾å¹¶è¿”å›ç»“æœ
3. å‘é€ï¼š"æ–°å‘˜å·¥å…¥èŒéœ€è¦ä»€ä¹ˆæµç¨‹ï¼Ÿ"
4. å±•ç¤º Agent è‡ªåŠ¨ç”Ÿæˆç­”æ¡ˆ

### åœºæ™¯å…­ï¼šç³»ç»Ÿç‰¹æ€§ï¼ˆ1åˆ†é’Ÿï¼‰
1. å±•ç¤ºå®¡è®¡æ—¥å¿—ï¼ˆmetadata_db/audit_logs.jsonlï¼‰
2. å±•ç¤ºç›‘æ§æŒ‡æ ‡ï¼ˆ/metricsï¼‰
3. æ€»ç»“ç³»ç»Ÿç‰¹ç‚¹

---

## ğŸ› ï¸ å¸¸è§é—®é¢˜

### Q1: å¯åŠ¨æ—¶æç¤º "æœªé…ç½® DeepSeek API Key"
**è§£å†³ï¼š** æ£€æŸ¥ `.env` æ–‡ä»¶ä¸­æ˜¯å¦åŒ…å« `OPENAI_API_KEY=sk-...`

### Q2: å¯¼å…¥æ–‡æ¡£æ—¶æç¤º "å‘é‡åº“æœªåˆå§‹åŒ–"
**è§£å†³ï¼š** ç¡®ä¿å…ˆè°ƒç”¨ `/ingest` æ¥å£å¯¼å…¥æ–‡æ¡£

### Q3: æœç´¢è¿”å›ç©ºç»“æœ
**è§£å†³ï¼š** 
1. ç¡®è®¤å·²æˆåŠŸå¯¼å…¥æ–‡æ¡£ï¼ˆæ£€æŸ¥è¿”å›çš„ documents æ•°é‡ï¼‰
2. å°è¯•ä½¿ç”¨æ›´é€šç”¨çš„å…³é”®è¯

### Q4: Token è¿‡æœŸ
**è§£å†³ï¼š** é‡æ–°è°ƒç”¨ `/auth/dev_login` è·å–æ–° token

---

## ğŸ“ å¿«é€Ÿæµ‹è¯•å‘½ä»¤é›†åˆ

æ‰€æœ‰å‘½ä»¤éƒ½å‡è®¾ä½ å·²ç»è·å–äº† tokenï¼ˆæ›¿æ¢ `<TOKEN>`ï¼‰ï¼š

```bash
# 1. è·å– Token
TOKEN=$(curl -s -X POST "http://127.0.0.1:8000/auth/dev_login" \
  -H "Content-Type: application/json" \
  -d '{"user":"demo_user","roles":["public"]}' | \
  python -c "import sys, json; print(json.load(sys.stdin)['data']['access_token'])")

# 2. å¯¼å…¥æ–‡æ¡£
curl -X POST "http://127.0.0.1:8000/ingest" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"paths": ["./demo_docs"]}'

# 3. æœç´¢
curl -X POST "http://127.0.0.1:8000/search" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"query": "å¹´å‡æ”¿ç­–", "k": 3}'

# 4. é—®ç­”
curl -X POST "http://127.0.0.1:8000/query" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"question": "å‘˜å·¥å¹´å‡æœ‰å¤šå°‘å¤©ï¼Ÿ"}'

# 5. Agent å¯¹è¯
curl -X POST "http://127.0.0.1:8000/agent_chat" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"message": "æœç´¢ä¸€ä¸‹å…³äºæŠ¥é”€æµç¨‹çš„æ–‡æ¡£"}'
```

---

## ğŸ¬ æ¼”ç¤ºè„šæœ¬

æˆ‘è¿˜ä¸ºä½ å‡†å¤‡äº†ä¸€ä¸ªè‡ªåŠ¨åŒ–æ¼”ç¤ºè„šæœ¬ `demo_script.py`ï¼Œå¯ä»¥ä¸€é”®è¿è¡Œæ‰€æœ‰æµ‹è¯•ï¼

```bash
python demo_script.py
```

---

**ç¥æ¼”ç¤ºé¡ºåˆ©ï¼** ğŸ‰
